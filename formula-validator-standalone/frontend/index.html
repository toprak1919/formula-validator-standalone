<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Formula Editor with Backend Validation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        :root {
            /* Green + white theme */
            --bg-primary: #f0fdf4;  /* emerald-50 */
            --bg-secondary: #ffffff;
            --bg-tertiary: #ecfdf5; /* emerald-50/100 */
            --bg-card: rgba(255, 255, 255, 0.98);
            --bg-glass: rgba(240, 253, 244, 0.85);
            --bg-glass-hover: rgba(220, 252, 231, 0.9);
            --bg-modal: rgba(5, 46, 22, 0.55);

            --text-primary: #064e3b;   /* emerald-900 */
            --text-secondary: #065f46; /* emerald-800 */
            --text-muted: #047857;     /* emerald-700 */

            --border-primary: rgba(16, 185, 129, 0.25);  /* emerald-500 */
            --border-secondary: rgba(16, 185, 129, 0.12);
            --border-focus: rgba(16, 185, 129, 0.45);

            --accent-primary: #10b981;   /* emerald-500 */
            --accent-secondary: #059669; /* emerald-600 */
            --accent-tertiary: #047857;  /* emerald-700 */
            --accent-warning: #f59e0b;   /* amber-500 */
            --accent-error: #dc2626;     /* red-600 */
            --accent-success: #16a34a;   /* green-600 */
            --accent-info: #10b981;      /* use green for info */

            --shadow-sm: 0 1px 2px rgba(6, 78, 59, 0.08);
            --shadow-md: 0 4px 6px rgba(16, 185, 129, 0.14);
            --shadow-lg: 0 10px 15px rgba(16, 185, 129, 0.18);
            --shadow-xl: 0 20px 25px rgba(16, 185, 129, 0.22);

            /* Code token colors */
            --code-keyword: #047857;  /* emerald-700 */
            --code-string:  #065f46;  /* emerald-800 */
            --code-number:  #059669;  /* emerald-600 */
            --code-constant:#10b981;  /* emerald-500 */
            --code-function:#0f766e;  /* teal-700 for separation */
            --code-operator:#047857;  /* emerald-700 */
            --code-comment: #64748b;  /* slate-500 for readability */
        }

        :root[data-theme='dark'] {
            --bg-primary: #0b1f1a;
            --bg-secondary: #0f2a22;
            --bg-tertiary: #123026;
            --bg-card: rgba(15, 42, 34, 0.95);
            --bg-glass: rgba(5, 24, 19, 0.65);
            --bg-glass-hover: rgba(7, 30, 24, 0.75);
            --bg-modal: rgba(0, 0, 0, 0.6);

            --text-primary: #d1fae5;
            --text-secondary: #a7f3d0;
            --text-muted: #86efac;

            --border-primary: rgba(16, 185, 129, 0.35);
            --border-secondary: rgba(16, 185, 129, 0.2);
            --border-focus: rgba(16, 185, 129, 0.55);

            --accent-primary: #10b981;
            --accent-secondary: #059669;
            --accent-tertiary: #047857;
            --accent-warning: #f59e0b;
            --accent-error: #dc2626;
            --accent-success: #16a34a;
            --accent-info: #10b981;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.35);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.45);

            --code-keyword: #34d399;
            --code-string:  #a7f3d0;
            --code-number:  #6ee7b7;
            --code-constant:#10b981;
            --code-function:#5eead4;
            --code-operator:#34d399;
            --code-comment: #94a3b8; /* slate-400 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            background-image: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #d1fae5 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-primary);
            animation: fadeIn 0.6s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-tertiary) 100%);
            color: white;
            padding: 24px 32px;
            border-bottom: 1px solid var(--border-primary);
            box-shadow: 0 2px 4px rgba(2, 132, 199, 0.15);
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .toolbar {
            background: var(--bg-glass);
            border-bottom: 1px solid var(--border-secondary);
            padding: 12px 24px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn.btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn.btn-danger {
            background: var(--accent-error);
        }

        .btn.btn-danger:hover {
            background: #b91c1c;
        }

        .btn-group {
            display: flex;
            gap: 4px;
            margin-left: auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: minmax(260px, 320px) 1fr minmax(320px, 420px);
            gap: 24px;
            padding: 24px;
            align-items: start;
        }

        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: minmax(240px, 280px) 1fr minmax(280px, 340px);
            }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-glass);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-secondary);
            backdrop-filter: blur(10px);
            animation: slideIn 0.6s ease;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title-text {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .panel-title-text::before {
            content: '';
            width: 8px;
            height: 20px;
            border-radius: 4px;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-secondary));
            display: inline-block;
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border-secondary);
            background: var(--bg-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
        }

        /* Generic icon container */
        .icon {
            width: 16px;
            height: 16px;
            position: relative;
            display: inline-block;
            color: currentColor;
        }

        /* Check mark icon */
        .icon-check::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 6px;
            height: 10px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(45deg);
            border-radius: 1px;
        }

        /* Trash icon */
        .icon-trash::before {
            content: '';
            position: absolute;
            left: 3px;
            top: 6px;
            width: 10px;
            height: 8px;
            border: 2px solid currentColor;
            border-top: 2px solid currentColor;
            border-bottom-left-radius: 2px;
            border-bottom-right-radius: 2px;
        }
        .icon-trash::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 3px;
            width: 8px;
            height: 2px;
            background: currentColor;
            border-radius: 1px;
            box-shadow: 2px 4px 0 -1px transparent; /* no-op, placeholder */
        }

        /* Edit (pencil) icon */
        .icon-edit::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 9px;
            width: 10px;
            height: 2px;
            background: currentColor;
            transform: rotate(-45deg);
            border-radius: 1px;
        }
        .icon-edit::after {
            content: '';
            position: absolute;
            left: 10px;
            top: 6px;
            width: 4px;
            height: 4px;
            background: currentColor;
            transform: rotate(45deg);
            border-radius: 1px;
        }

        /* Document icon */
        .icon-doc::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 12px;
            height: 14px;
            border: 2px solid currentColor;
            border-radius: 2px;
        }
        .icon-doc::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 6px;
            width: 8px;
            height: 2px;
            background: currentColor;
            box-shadow: 0 4px 0 0 currentColor, 0 8px 0 0 currentColor;
            border-radius: 1px;
        }

        /* List icon */
        .icon-list::before {
            content: '';
            position: absolute;
            left: 3px;
            top: 4px;
            width: 10px;
            height: 2px;
            background: currentColor;
            border-radius: 1px;
            box-shadow: 0 4px 0 0 currentColor, 0 8px 0 0 currentColor;
        }

        /* Copy icon */
        .icon-copy::before,
        .icon-copy::after {
            content: '';
            position: absolute;
            border: 2px solid currentColor;
            border-radius: 2px;
            width: 10px;
            height: 12px;
        }
        .icon-copy::before { left: 2px; top: 2px; background: transparent; }
        .icon-copy::after { left: 4px; top: 4px; background: transparent; }

        /* Refresh icon */
        .icon-refresh::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-radius: 50%;
        }
        .icon-refresh::after {
            content: '';
            position: absolute;
            right: 1px;
            top: 2px;
            width: 0;
            height: 0;
            border-left: 5px solid currentColor;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
        }

        /* Sun/Moon icons for theme toggle */
        .icon-moon::before,
        .icon-sun::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: currentColor;
        }
        .icon-moon::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-secondary);
        }
        .icon-sun::after {
            content: '';
            position: absolute;
            left: 7px; top: 7px;
            width: 2px; height: 2px;
            background: currentColor;
            border-radius: 50%;
            box-shadow:
              -7px 0 0 0 currentColor,
              7px 0 0 0 currentColor,
              0 -7px 0 0 currentColor,
              0 7px 0 0 currentColor,
              5px 5px 0 0 currentColor,
              -5px 5px 0 0 currentColor,
              5px -5px 0 0 currentColor,
              -5px -5px 0 0 currentColor;
        }

        .source-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: clamp(260px, 50vh, 560px);
            overflow-y: auto;
            padding-right: 4px;
            overscroll-behavior: contain;
        }

        .source-list::-webkit-scrollbar {
            width: 6px;
        }

        .source-list::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        .source-list::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 3px;
        }

        .source-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .source-item:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
            transform: translateX(2px);
            box-shadow: var(--shadow-sm);
        }

        .source-item.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.06));
            border-color: var(--accent-primary);
        }

        .source-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-primary);
        }

        .source-item.editing {
            background: #ffffff;
            cursor: default;
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.12);
            overflow: visible;
        }
        .source-item.editing .source-name {
            max-width: 100%;
            white-space: normal;
        }
        .source-item .source-value { word-break: break-word; }

        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 8px;
        }

        .source-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .source-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .source-item:hover .source-actions {
            opacity: 1;
        }

        .source-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            overflow-wrap: anywhere;
        }

        .source-value {
            font-size: 12px;
            color: var(--text-muted);
        }

        .source-edit-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        /* Subtle separators between stacked fields */
        .source-edit-form .input-group + .input-group {
            padding-top: 8px;
            border-top: 1px solid var(--border-secondary);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .input-group label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .field-help {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.3;
        }

        .input-group input {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            width: 100%;
        }

        .input-group select {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
            width: 100%;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        /* Green accent focus when editing a source */
        .source-item.editing .input-group input:focus {
            border-color: var(--accent-success);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.15);
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            justify-content: flex-start;
        }

        /* Edit form is stacked vertically on all sizes */

        /* Success button variant for green/white scheme */
        .btn-success {
            background: var(--accent-success);
            color: #ffffff;
        }
        .btn-success:hover {
            background: #15803d; /* green-700 */
        }
        .source-item.editing .btn.btn-secondary:hover {
            border-color: var(--accent-success);
        }

        .search-box {
            margin-bottom: 12px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px 8px 32px;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            font-size: 13px;
            background: var(--bg-secondary);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        /* Search icon (CSS only, no emoji) */
        .search-box::before, .search-box::after {
            content: '';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .search-box::before {
            width: 12px;
            height: 12px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            margin-top: -1px;
        }
        .search-box::after {
            width: 6px;
            height: 2px;
            background: var(--text-muted);
            transform: translate(6px, 3px) rotate(45deg);
        }

        .editor-container {
            position: relative;
        }

        #editor {
            width: 100%;
            height: 400px;
            border-radius: 12px;
            border: 2px solid var(--border-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            transition: all 0.2s ease;
        }

        #editor:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        }

        /* ACE Editor text visibility fix */
        .ace_editor {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        /* Ensure scroller inherits theme background (fixes white editor in dark) */
        .ace_editor .ace_scroller {
            background-color: var(--bg-secondary) !important;
        }

        .ace_editor .ace_text-layer {
            color: var(--text-primary) !important;
        }

        /* Input caret layer */
        .ace_editor .ace_text-input {
            color: var(--text-primary) !important;
            background-color: transparent !important;
        }

        .ace_editor .ace_cursor {
            color: var(--text-primary) !important;
            border-color: var(--text-primary) !important;
        }

        .ace_editor .ace_content {
            color: var(--text-primary) !important;
        }

        .ace_editor .ace_gutter {
            background: var(--bg-tertiary) !important;
            color: var(--text-muted) !important;
        }

        .ace_editor .ace_gutter-active-line {
            background: rgba(16, 185, 129, 0.12) !important;
        }

        .ace_editor .ace_marker-layer .ace_selection {
            background: rgba(16, 185, 129, 0.2) !important;
        }

        .ace_editor .ace_marker-layer .ace_active-line {
            background: rgba(16, 185, 129, 0.08) !important;
        }

        /* Variable and constant highlighting */
        /* Note: Custom syntax highlighting for $ and # is disabled due to ACE compatibility */
        /* These styles are kept for future use if we implement a custom mode */
        .ace_editor .ace_variable.ace_language {
            color: var(--accent-primary) !important;
            font-weight: 600;
        }

        .ace_editor .ace_constant.ace_language {
            color: var(--accent-secondary) !important;
            font-weight: 600;
        }

        /* ACE token colors - green accent */
        .ace_editor .ace_keyword,
        .ace_editor .ace_storage { color: var(--code-keyword) !important; font-weight: 600; }
        .ace_editor .ace_string { color: var(--code-string) !important; }
        .ace_editor .ace_numeric { color: var(--code-number) !important; }
        .ace_editor .ace_constant,
        .ace_editor .ace_support.ace_constant { color: var(--code-constant) !important; }
        .ace_editor .ace_support.ace_function,
        .ace_editor .ace_entity.ace_name.ace_function { color: var(--code-function) !important; }
        .ace_editor .ace_operator { color: var(--code-operator) !important; }
        .ace_editor .ace_comment { color: var(--code-comment) !important; font-style: italic; }
        .ace_editor .ace_paren,
        .ace_editor .ace_punctuation { color: var(--text-secondary) !important; }
        .ace_editor .ace_bracket { color: var(--accent-secondary) !important; }
        .ace_editor .ace_identifier { color: var(--text-primary) !important; }
        .ace_editor .ace_variable.ace_parameter { color: var(--text-secondary) !important; }
        .ace_editor .ace_constant.ace_numeric { color: var(--code-number) !important; }
        .ace_editor .ace_invalid { color: #fff !important; background-color: rgba(220, 38, 38, 0.6) !important; }
        .ace_editor .ace_marker-layer .ace_selected-word { border: 1px solid var(--accent-primary) !important; }

        /* Autocomplete dropdown */
        .ace_editor.ace_autocomplete {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-primary) !important;
            border-radius: 8px !important;
            box-shadow: var(--shadow-lg) !important;
            color: var(--text-primary) !important;
        }

        .ace_editor.ace_autocomplete .ace_marker-layer .ace_active-line {
            background: rgba(16, 185, 129, 0.12) !important;
        }

        .ace_editor.ace_autocomplete .ace_line-hover {
            background: rgba(16, 185, 129, 0.08) !important;
        }

        .ace_editor.ace_autocomplete .ace_completion-highlight {
            color: var(--accent-primary) !important;
            font-weight: bold;
        }

        .validation-status {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border-secondary);
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .validation-status.valid {
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.1), rgba(22, 163, 74, 0.08));
            border-color: var(--accent-success);
            color: var(--accent-success);
        }

        .validation-status.error {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.15), rgba(220, 38, 38, 0.1));
            border-color: var(--accent-error);
            color: var(--accent-error);
        }

        .validation-status.validating {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.1));
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .status-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            position: relative;
        }
        /* Default idle dot */
        .validation-status .status-icon::before {
            content: '';
            position: absolute;
            inset: 3px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        /* Valid check */
        .validation-status.valid .status-icon::before {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 5px;
            height: 9px;
            border-right: 2px solid var(--accent-success);
            border-bottom: 2px solid var(--accent-success);
            transform: rotate(45deg);
            border-radius: 1px;
            background: transparent;
        }
        /* Error cross */
        .validation-status.error .status-icon::before,
        .validation-status.error .status-icon::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 7px;
            width: 10px;
            height: 2px;
            background: var(--accent-error);
            border-radius: 1px;
        }
        .validation-status.error .status-icon::before { transform: rotate(45deg); }
        .validation-status.error .status-icon::after { transform: rotate(-45deg); }

        .errors-container {
            margin-top: 16px;
            background: rgba(220, 38, 38, 0.05);
            border: 1px solid rgba(220, 38, 38, 0.2);
            border-radius: 8px;
            padding: 12px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .errors-container.show {
            display: block;
        }

        .error-item {
            color: var(--accent-error);
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            align-items: start;
            gap: 8px;
            padding: 8px;
            background: rgba(220, 38, 38, 0.05);
            border-radius: 6px;
            border-left: 3px solid var(--accent-error);
        }

        .error-item:last-child {
            margin-bottom: 0;
        }

        .error-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            background: var(--accent-error);
            color: white;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .result-section {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.06), rgba(16, 185, 129, 0.03));
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
        }

        .result-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .result-copy {
            font-size: 14px;
            padding: 4px 8px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        .result-copy:hover {
            opacity: 1;
        }

        .formula-history {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-secondary);
        }

        .history-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: clamp(100px, 22vh, 220px);
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        .history-item {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
        }

        .history-result {
            color: var(--text-muted);
            font-size: 11px;
        }

        .functions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: clamp(260px, 50vh, 560px);
            overflow-y: auto;
            padding-right: 4px;
            overscroll-behavior: contain;
        }

        .function-item {
            padding: 10px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
            outline: none;
        }

        .function-item:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .function-item:focus-visible,
        .source-item:focus-visible,
        .icon-btn:focus-visible,
        .btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .function-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .function-desc {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border-secondary);
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab:hover {
            color: var(--text-secondary);
        }

        .tab.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        /* Sticky tabs inside panels for improved UX */
        .panel .tabs {
            position: sticky;
            top: 0;
            background: var(--bg-glass);
            z-index: 5;
            padding-top: 8px;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(16, 185, 129, 0.25);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .backend-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-glass);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
        }

        .backend-indicator.active {
            border-color: var(--accent-primary);
            background: rgba(16, 185, 129, 0.12);
            animation: pulse 2s infinite;
        }

        .backend-indicator .request-count {
            background: var(--accent-primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-modal);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.001ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.001ms !important;
                scroll-behavior: auto !important;
            }
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-secondary);
            background: var(--bg-tertiary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .modal-close:hover {
            background: var(--bg-glass-hover);
            border-color: var(--accent-primary);
        }
        .modal-close::before,
        .modal-close::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 2px;
            background: var(--text-secondary);
            border-radius: 2px;
        }
        .modal-close::before { transform: rotate(45deg); }
        .modal-close::after { transform: rotate(-45deg); }

        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            align-items: center;
        }

        .test-speed {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
        }

        .test-speed label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .test-speed select {
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-tertiary);
        }

        .test-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .test-results {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .test-result {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-result.pass {
            background: rgba(22, 163, 74, 0.05);
            border-color: var(--accent-success);
        }

        .test-result.fail {
            background: rgba(220, 38, 38, 0.05);
            border-color: var(--accent-error);
        }

        .test-info {
            flex: 1;
        }

        .test-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .test-formula {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .test-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: relative;
        }

        .test-icon.pass { background: var(--accent-success); }

        .test-icon.fail { background: var(--accent-error); }

        .test-icon.pass::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            width: 6px;
            height: 12px;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            transform: rotate(45deg);
            border-radius: 1px;
        }

        .test-icon.fail::before,
        .test-icon.fail::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 11px;
            width: 12px;
            height: 2px;
            background: #fff;
            border-radius: 1px;
        }
        .test-icon.fail::before { transform: rotate(45deg); }
        .test-icon.fail::after { transform: rotate(-45deg); }

        .test-expected {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--accent-success);
            background: linear-gradient(135deg, rgba(22, 163, 74, 0.1), rgba(22, 163, 74, 0.06));
        }

        .toast.error {
            border-color: var(--accent-error);
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05));
        }

        .toast.info {
            border-color: var(--accent-info);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            position: relative;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: var(--accent-success); }
        .toast.error .toast-icon { background: var(--accent-error); }
        .toast.info .toast-icon { background: var(--accent-info); }

        .toast.success .toast-icon::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 5px;
            width: 6px;
            height: 12px;
            border-right: 2px solid #fff;
            border-bottom: 2px solid #fff;
            transform: rotate(45deg);
            border-radius: 1px;
        }
        .toast.error .toast-icon::before,
        .toast.error .toast-icon::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 11px;
            width: 12px;
            height: 2px;
            background: #fff;
            border-radius: 1px;
        }
        .toast.error .toast-icon::before { transform: rotate(45deg); }
        .toast.error .toast-icon::after { transform: rotate(-45deg); }
        .toast.info .toast-icon::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 6px;
            width: 2px;
            height: 10px;
            background: #fff;
            border-radius: 1px;
        }
        .toast.info .toast-icon::after {
            content: '';
            position: absolute;
            left: 11px;
            top: 4px;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
        }

        .toast-message {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
        }

        .toast-close {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s ease;
            width: 18px;
            height: 18px;
            position: relative;
        }
        .toast-close::before,
        .toast-close::after {
            content: '';
            position: absolute;
            left: 2px;
            top: 8px;
            width: 14px;
            height: 2px;
            background: var(--text-secondary);
            border-radius: 2px;
        }
        .toast-close::before { transform: rotate(45deg); }
        .toast-close::after { transform: rotate(-45deg); }
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Glassmorphism effects */
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced Formula Editor with Backend Validation (mXparser)</h1>
            <p>Professional formula validation and evaluation with advanced features</p>
        </div>

        <div class="toolbar">
            <button class="btn" id="validateBtn">
                <span class="icon icon-check" aria-hidden="true"></span>
                Validate
            </button>
            <button class="btn btn-secondary" id="clearBtn">
                <span class="icon icon-trash" aria-hidden="true"></span>
                Clear
            </button>
            <button class="btn btn-secondary" id="samplesBtn">
                <span class="icon icon-doc" aria-hidden="true"></span>
                Samples
            </button>
            <button class="btn btn-secondary" id="testSuiteBtn">
                <span class="icon icon-list" aria-hidden="true"></span>
                Test Suite
            </button>
            <button class="btn btn-secondary" id="copyFormulaBtn">
                <span class="icon icon-copy" aria-hidden="true"></span>
                Copy Formula
            </button>
            <button class="btn btn-secondary" id="copyResultBtn">
                <span class="icon icon-copy" aria-hidden="true"></span>
                Copy Result
            </button>
            <button class="btn btn-secondary" id="themeToggleBtn">
                <span class="icon icon-moon" aria-hidden="true"></span>
                Theme
            </button>
            <div class="btn-group">
                <button class="btn btn-secondary" id="simulateChangeBtn">
                    <span class="icon icon-refresh" aria-hidden="true"></span>
                    Simulate Changes
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Left Panel - Sources -->
            <div class="panel">
                <div class="tabs">
                    <button class="tab active" data-tab="measured">Measured Values</button>
                    <button class="tab" data-tab="constants">Constants</button>
                </div>

                <div class="tab-content active" id="measuredTab">
                    <div class="panel-title">
                        <div class="panel-title-text">
                            Measured Values
                        </div>
                        <div class="panel-actions">
                            <button class="icon-btn" id="addMeasuredBtn" title="Add New">+</button>
                        </div>
                    </div>
                    <div class="search-box">
                        <input type="text" placeholder="Search measured values..." id="measuredSearch">
                    </div>
                    <div class="source-list" id="measuredValuesList"></div>
                </div>

                <div class="tab-content" id="constantsTab">
                    <div class="panel-title">
                        <div class="panel-title-text">
                            Constants
                        </div>
                        <div class="panel-actions">
                            <button class="icon-btn" id="addConstantBtn" title="Add New">+</button>
                        </div>
                    </div>
                    <div class="search-box">
                        <input type="text" placeholder="Search constants..." id="constantsSearch">
                    </div>
                    <div class="source-list" id="constantsList"></div>
                </div>
            </div>

            <!-- Center Panel - Editor -->
            <div class="panel">
                <div class="panel-title">
                    <div class="panel-title-text">Formula Editor</div>
                </div>
                <div class="editor-container">
                    <div class="validation-status" id="validationStatus">
                        <span class="status-icon"></span>
                        <span>Ready</span>
                    </div>
                    <div id="editor"></div>
                </div>
                <div class="errors-container" id="errorsContainer">
                    <div id="errorsList"></div>
                </div>
                <div class="result-section">
                    <div class="result-label">Calculation Result</div>
                    <div class="result-value">
                        <span id="resultValue">Enter a formula...</span>
                        <button class="btn btn-secondary result-copy" id="resultCopyBtn">
                            <span class="icon icon-copy" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
                <div class="formula-history">
                    <div class="history-title">Formula History</div>
                    <div class="history-list" id="historyList"></div>
                </div>
            </div>

            <!-- Right Panel - Functions -->
            <div class="panel">
                    <div class="panel-title">
                        <div class="panel-title-text">Functions</div>
                    </div>
                <div class="tabs">
                    <button class="tab active" data-tab="basic-func">Basic</button>
                    <button class="tab" data-tab="trig-func">Trigonometric</button>
                    <button class="tab" data-tab="math-func">Mathematical</button>
                    <button class="tab" data-tab="stat-func">Statistical</button>
                </div>
                <div class="tab-content active" id="basic-funcTab">
                    <div class="functions-grid" id="basicFunctions"></div>
                </div>
                <div class="tab-content" id="trig-funcTab">
                    <div class="functions-grid" id="trigFunctions"></div>
                </div>
                <div class="tab-content" id="math-funcTab">
                    <div class="functions-grid" id="mathFunctions"></div>
                </div>
                <div class="tab-content" id="stat-funcTab">
                    <div class="functions-grid" id="statFunctions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Backend Indicator -->
    <div class="backend-indicator" id="backendIndicator">
        <span>Backend: Ready</span>
        <span class="request-count" id="requestCount">0</span>
    </div>

    <!-- Test Suite Modal -->
    <div class="modal" id="testModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Formula Test Suite</h2>
                <button class="modal-close" id="closeTestModal" aria-label="Close"></button>
            </div>
            <div class="test-controls">
                <button class="btn" id="runTestsBtn">Run All Tests</button>
                <button class="btn btn-secondary" id="exportTestsBtn">Export Results</button>
                <div class="test-speed">
                    <label>Speed:</label>
                    <select id="testSpeed">
                        <option value="instant">Instant</option>
                        <option value="fast">Fast</option>
                        <option value="normal">Normal</option>
                    </select>
                </div>
            </div>
            <div class="test-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="testProgress" style="width: 0%"></div>
                </div>
                <div class="progress-stats">
                    <span id="testProgressText">0 / 0 tests</span>
                    <span id="testStats">Pass: 0 | Fail: 0</span>
                </div>
            </div>
            <div class="test-results" id="testResults"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ACE Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ext-language_tools.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-textmate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-chrome.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-twilight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/theme-tomorrow_night.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/mode-javascript.min.js"></script>

    <script>
        // Application State
        let editor;
        let validationTimeout;
        let requestCount = 0;
        let formulaHistory = [];
        let testCases = [];
        let currentTestIndex = 0;
        let testRunning = false;

        // Data sources
        let measuredValues = {
            '$temperature': { name: 'Temperature', value: 25.5, unit: 'C' },
            '$pressure': { name: 'Pressure', value: 101.3 },
            '$humidity': { name: 'Humidity', value: 65.2 },
            '$flow_rate': { name: 'Flow Rate', value: 12.8 },
            '$voltage': { name: 'Voltage', value: 220.0, unit: 'V' }
        };

        let constants = {
            '#pi': { name: 'Pi', value: 3.14159 },
            '#gravity': { name: 'Gravity', value: 9.81 },
            '#max_temp': { name: 'Max Temperature', value: 100.0 },
            '#min_temp': { name: 'Min Temperature', value: -10.0 },
            '#conversion_factor': { name: 'Conversion Factor', value: 1.8 }
        };

        // Functions database
        const functionsDB = {
            basic: [
                { name: 'abs(x)', desc: 'Absolute value' },
                { name: 'sign(x)', desc: 'Sign function' },
                { name: 'sgn(x)', desc: 'Signum' },
                { name: 'mod(x,y)', desc: 'Modulo' },
                { name: 'fact(n)', desc: 'Factorial' },
                { name: 'gcd(a,b)', desc: 'GCD' },
                { name: 'lcm(a,b)', desc: 'LCM' }
            ],
            trig: [
                { name: 'sin(x)', desc: 'Sine' },
                { name: 'cos(x)', desc: 'Cosine' },
                { name: 'tan(x)', desc: 'Tangent' },
                { name: 'asin(x)', desc: 'Arcsine' },
                { name: 'acos(x)', desc: 'Arccosine' },
                { name: 'atan(x)', desc: 'Arctangent' },
                { name: 'sinh(x)', desc: 'Hyperbolic sine' },
                { name: 'cosh(x)', desc: 'Hyperbolic cos' },
                { name: 'tanh(x)', desc: 'Hyperbolic tan' }
            ],
            math: [
                { name: 'sqrt(x)', desc: 'Square root' },
                { name: 'exp(x)', desc: 'Exponential' },
                { name: 'ln(x)', desc: 'Natural log' },
                { name: 'log10(x)', desc: 'Log base 10' },
                { name: 'log2(x)', desc: 'Log base 2' },
                { name: 'pow(x,y)', desc: 'Power x^y' },
                { name: 'floor(x)', desc: 'Floor' },
                { name: 'ceil(x)', desc: 'Ceiling' },
                { name: 'round(x,n)', desc: 'Round' }
            ],
            stat: [
                { name: 'min(...)', desc: 'Minimum' },
                { name: 'max(...)', desc: 'Maximum' },
                { name: 'avg(...)', desc: 'Average' },
                { name: 'sum(...)', desc: 'Sum' },
                { name: 'prod(...)', desc: 'Product' },
                { name: 'std(...)', desc: 'Std deviation' },
                { name: 'var(...)', desc: 'Variance' }
            ]
        };

        // Initialize ACE Editor
        function initializeEditor() {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/chrome");
            editor.session.setMode("ace/mode/javascript");

            // Enable language tools
            ace.require("ace/ext/language_tools");

            editor.setOptions({
                fontSize: "15px",
                showGutter: true,
                highlightActiveLine: true,
                wrap: true,
                enableBasicAutocompletion: true,
                enableSnippets: true,
                enableLiveAutocompletion: true,
                showPrintMargin: false
            });

            // Custom syntax highlighting for $ and #
            // Removed due to compatibility issues with ACE v1.32.2
            // This was causing "Cannot read properties of undefined" errors
            // Variables ($) and constants (#) still work in autocomplete

            // Available units for autocomplete
            const availableUnits = [
                { name: 'meter', aliases: ['m', 'meters', 'metre'], description: 'Base unit of length' },
                { name: 'kilometer', aliases: ['km', 'kilometre'], description: '1000 meters' },
                { name: 'astronomical', aliases: ['au', 'astronomical_unit', 'astronomicalunit'], description: 'Astronomical unit (~150M km)' }
            ];

            // Custom autocomplete
            const customCompleter = {
                getCompletions: function(editor, session, pos, prefix, callback) {
                    const completions = [];

                    // Get the text before cursor to check for unit completion
                    const line = session.getLine(pos.row);
                    const textBeforeCursor = line.substring(0, pos.column);

                    // Check if we're after a variable followed by a dot, with optional unit prefix
                    // Examples it should match:
                    // - "$temperature." (empty unit prefix)
                    // - "$temperature.k" (partial unit prefix)
                    const varDotPattern = /\$([a-zA-Z_][a-zA-Z0-9_]*)\.\s*([a-zA-Z_]*)$/;
                    const varDotMatch = textBeforeCursor.match(varDotPattern);

                    if (varDotMatch) {
                        // We're after a variable dot, show unit suggestions
                        const varName = '$' + varDotMatch[1];
                        const typedUnitPrefix = (varDotMatch[2] || '').toLowerCase();
                        const variable = measuredValues[varName];

                        // Helper to push a completion if it matches the typed prefix
                        function pushIfMatches(caption, value, meta, score) {
                            if (!typedUnitPrefix || caption.toLowerCase().startsWith(typedUnitPrefix)) {
                                completions.push({ caption, value, meta, score });
                            }
                        }

                        // Add available units (and aliases), filtered by the typed prefix after the dot
                        availableUnits.forEach(unit => {
                            // Main unit name
                            pushIfMatches(unit.name, unit.name, unit.description, 1100);
                            // Aliases
                            unit.aliases.forEach(alias => {
                                if (alias !== unit.name) {
                                    pushIfMatches(alias, alias, `Alias for ${unit.name}`, 1050);
                                }
                            });
                        });

                        // If the variable has a unit, show it
                        if (variable && variable.unit) {
                            completions.forEach(c => {
                                if (
                                    c.caption.toLowerCase() === variable.unit.toLowerCase() ||
                                    c.caption.toLowerCase() === 'meter' ||
                                    c.caption.toLowerCase() === 'm'
                                ) {
                                    c.meta += ' (current unit)';
                                }
                            });
                        }
                    } else {
                        // Normal autocomplete for variables, constants, and functions

                        // Add measured values
                        Object.entries(measuredValues).forEach(([key, data]) => {
                            completions.push({
                                caption: key,
                                value: key,
                                meta: `Value: ${data.value}${data.unit ? ` (${data.unit})` : ''}`,
                                score: 1000
                            });
                        });

                        // Add constants
                        Object.entries(constants).forEach(([key, data]) => {
                            completions.push({
                                caption: key,
                                value: key,
                                meta: `Value: ${data.value}`,
                                score: 900
                            });
                        });

                        // Add functions
                        [...functionsDB.basic, ...functionsDB.trig, ...functionsDB.math, ...functionsDB.stat].forEach(func => {
                            completions.push({
                                caption: func.name,
                                value: func.name.split('(')[0] + '(',
                                meta: func.desc,
                                score: 800
                            });
                        });
                    }

                    callback(null, completions);
                }
            };

            editor.completers = [customCompleter];

            // Trigger autocomplete immediately after typing a dot following a variable
            editor.commands.on('afterExec', function(e) {
                if (e.command && e.command.name === 'insertstring' && e.args === '.') {
                    editor.execCommand('startAutocomplete');
                }
            });

            // Set initial value
            editor.setValue("($temperature * #conversion_factor) + 32", 1);

            // Add change listener with debouncing
            editor.session.on('change', () => {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(performBackendValidation, 300);
                updateValidationStatus('validating');
            });
        }

        // Render source lists
        function renderSourceLists() {
            renderMeasuredValues();
            renderConstants();
        }

        function renderMeasuredValues(searchTerm = '') {
            const list = document.getElementById('measuredValuesList');
            list.innerHTML = '';

            Object.entries(measuredValues)
                .filter(([key, data]) =>
                    key.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    data.name.toLowerCase().includes(searchTerm.toLowerCase())
                )
                .forEach(([key, data]) => {
                    const item = createSourceItem(key, data, 'measured');
                    list.appendChild(item);
                });
        }

        function renderConstants(searchTerm = '') {
            const list = document.getElementById('constantsList');
            list.innerHTML = '';

            Object.entries(constants)
                .filter(([key, data]) =>
                    key.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    data.name.toLowerCase().includes(searchTerm.toLowerCase())
                )
                .forEach(([key, data]) => {
                    const item = createSourceItem(key, data, 'constant');
                    list.appendChild(item);
                });
        }

        function createSourceItem(key, data, type) {
            const item = document.createElement('div');
            item.className = 'source-item';
            item.dataset.key = key;
            item.tabIndex = 0;
            item.title = `Insert ${key} into editor`;

            item.innerHTML = `
                <div class="source-header">
                    <div class="source-name">${data.name}</div>
                    <div class="source-actions">
                        <button class="icon-btn edit-btn" title="Edit" aria-label="Edit">
                            <span class="icon icon-edit" aria-hidden="true"></span>
                        </button>
                        <button class="icon-btn delete-btn" title="Delete" aria-label="Delete">
                            <span class="icon icon-trash" aria-hidden="true"></span>
                        </button>
                    </div>
                </div>
                <div class="source-code">${key}</div>
                <div class="source-value">Value: ${data.value}${data.unit ? ' (' + data.unit + ')' : ''}</div>
            `;

            // Click/keyboard to insert
            const handleInsert = (e) => {
                if (!e.target.closest('.source-actions') && !item.classList.contains('editing')) {
                    insertIntoEditor(key);
                    item.classList.add('active');
                    setTimeout(() => item.classList.remove('active'), 500);
                }
            };
            item.addEventListener('click', handleInsert);
            item.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    handleInsert(e);
                }
            });

            // Edit button
            item.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                showEditForm(item, key, data, type);
            });

            // Delete button
            item.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`Delete ${data.name}?`)) {
                    if (type === 'measured') {
                        delete measuredValues[key];
                        renderMeasuredValues();
                    } else {
                        delete constants[key];
                        renderConstants();
                    }
                    showToast(`${data.name} deleted`, 'info');
                    performBackendValidation();
                }
            });

            return item;
        }

        function showEditForm(item, key, data, type) {
            item.classList.add('editing');

            const form = document.createElement('div');
            form.className = 'source-edit-form';
            form.innerHTML = `
                <div class="input-group">
                    <label for="editName">Name</label>
                    <input type="text" value="${data.name}" id="editName" placeholder="e.g., Temperature">
                    <div class="field-help">Display name shown in lists and suggestions.</div>
                </div>
                <div class="input-group">
                    <label for="editValue">Value</label>
                    <input type="number" value="${data.value}" step="any" id="editValue" placeholder="e.g., 25.5">
                    <div class="field-help">Numeric value (decimals supported). Uses dot for decimal separator.</div>
                </div>
                ${type === 'measured' ? `
                <div class="input-group">
                    <label for="editUnitSelect">Unit (optional)</label>
                    <select id="editUnitSelect">
                        <option value="">None</option>
                        <optgroup label="Length">
                            <option value="m">meter (m)</option>
                            <option value="cm">centimeter (cm)</option>
                            <option value="mm">millimeter (mm)</option>
                            <option value="km">kilometer (km)</option>
                            <option value="in">inch (in)</option>
                            <option value="ft">foot (ft)</option>
                            <option value="yd">yard (yd)</option>
                            <option value="mi">mile (mi)</option>
                        </optgroup>
                        <optgroup label="Mass">
                            <option value="kg">kilogram (kg)</option>
                            <option value="g">gram (g)</option>
                        </optgroup>
                        <optgroup label="Time">
                            <option value="s">second (s)</option>
                            <option value="ms">millisecond (ms)</option>
                            <option value="min">minute (min)</option>
                            <option value="h">hour (h)</option>
                        </optgroup>
                        <optgroup label="Temperature">
                            <option value="K">kelvin (K)</option>
                            <option value="C">celsius (C)</option>
                            <option value="F">fahrenheit (F)</option>
                        </optgroup>
                        <optgroup label="Electricity">
                            <option value="A">ampere (A)</option>
                            <option value="V">volt (V)</option>
                            <option value="">ohm ()</option>
                        </optgroup>
                        <optgroup label="Other">
                            <option value="L">litre (L)</option>
                            <option value="mL">millilitre (mL)</option>
                            <option value="Pa">pascal (Pa)</option>
                            <option value="bar">bar (bar)</option>
                            <option value="N">newton (N)</option>
                            <option value="J">joule (J)</option>
                            <option value="W">watt (W)</option>
                            <option value="%">percent (%)</option>
                        </optgroup>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="text" id="editUnitCustom" placeholder="Enter custom unit" style="display:none;margin-top:6px;">
                    <div class="field-help">Choose common units or select Custom to enter your own.</div>
                </div>
                ` : ''}
                <div class="edit-actions">
                    <button class="btn btn-success" id="saveEdit">Save</button>
                    <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
                </div>
            `;

            item.appendChild(form);

            // Unit dropdown behavior (measured only)
            if (type === 'measured') {
                const unitSelect = form.querySelector('#editUnitSelect');
                const unitCustom = form.querySelector('#editUnitCustom');

                // Preselect current unit
                const currentUnit = (data.unit || '').trim();
                if (currentUnit) {
                    const found = Array.from(unitSelect.options).some(opt => opt.value === currentUnit);
                    if (found) unitSelect.value = currentUnit; else unitSelect.value = 'custom';
                    if (unitSelect.value === 'custom') {
                        unitCustom.style.display = '';
                        unitCustom.value = currentUnit;
                    }
                }

                unitSelect.addEventListener('change', () => {
                    if (unitSelect.value === 'custom') {
                        unitCustom.style.display = '';
                        unitCustom.focus();
                    } else {
                        unitCustom.style.display = 'none';
                    }
                });
            }

            form.querySelector('#saveEdit').addEventListener('click', () => {
                const newData = {
                    name: form.querySelector('#editName').value,
                    value: parseFloat(form.querySelector('#editValue').value)
                };

                if (type === 'measured') {
                    const unitSelect = form.querySelector('#editUnitSelect');
                    const unitCustom = form.querySelector('#editUnitCustom');
                    let unitVal = '';
                    if (unitSelect) {
                        if (unitSelect.value === 'custom') {
                            unitVal = (unitCustom.value || '').trim();
                        } else {
                            unitVal = unitSelect.value;
                        }
                    }
                    if (unitVal) newData.unit = unitVal;
                    measuredValues[key] = newData;
                    renderMeasuredValues();
                } else {
                    constants[key] = newData;
                    renderConstants();
                }

                showToast(`${newData.name} updated`, 'success');
                performBackendValidation();
            });

            form.querySelector('#cancelEdit').addEventListener('click', () => {
                item.classList.remove('editing');
                form.remove();
            });
        }

        function insertIntoEditor(text) {
            editor.session.insert(editor.getCursorPosition(), text);
            editor.focus();
        }

        // Validation functions
        function updateValidationStatus(status, message = '') {
            const statusEl = document.getElementById('validationStatus');
            statusEl.className = `validation-status ${status}`;

            switch(status) {
                case 'valid':
                    statusEl.innerHTML = '<span class="status-icon"></span><span>Valid</span>';
                    break;
                case 'error':
                    statusEl.innerHTML = '<span class="status-icon"></span><span>Error</span>';
                    break;
                case 'validating':
                    statusEl.innerHTML = '<span class="status-icon"><div class="loading-spinner"></div></span><span>Validating...</span>';
                    break;
                default:
                    statusEl.innerHTML = '<span class="status-icon"></span><span>Ready</span>';
            }
        }

        function showErrors(errors) {
            const errorsContainer = document.getElementById('errorsContainer');
            const errorsList = document.getElementById('errorsList');

            if (errors && errors.length > 0) {
                errorsList.innerHTML = errors.map(error => `
                    <div class="error-item">
                        <span class="error-icon">!</span>
                        <span>${error}</span>
                    </div>
                `).join('');
                errorsContainer.classList.add('show');
            } else {
                errorsContainer.classList.remove('show');
            }
        }

        function updateResult(value) {
            const resultEl = document.getElementById('resultValue');
            if (value !== null && value !== undefined) {
                const formatted = typeof value === 'number' ? value.toFixed(6) : value;
                resultEl.textContent = formatted;
            } else {
                resultEl.textContent = 'Enter a valid formula...';
            }
        }

        function updateBackendIndicator(active, message = 'Ready') {
            const indicator = document.getElementById('backendIndicator');
            indicator.className = `backend-indicator ${active ? 'active' : ''}`;
            indicator.querySelector('span:first-child').textContent = `Backend: ${message}`;

            if (active) {
                requestCount++;
                document.getElementById('requestCount').textContent = requestCount;
            }
        }

        async function performBackendValidation() {
            const formula = editor.getValue();

            if (!formula || formula.trim() === '') {
                updateValidationStatus('');
                showErrors([]);
                updateResult(null);
                return;
            }

            updateBackendIndicator(true, 'Validating...');

            const requestData = {
                formula: formula,
                measuredValues: Object.entries(measuredValues).map(([id, data]) => ({
                    id: id,
                    name: data.name,
                    value: data.value,
                    unit: data.unit
                })),
                constants: Object.entries(constants).map(([id, data]) => ({
                    id: id,
                    name: data.name,
                    value: data.value
                }))
            };

            try {
                const response = await fetch(API_CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: `
                            mutation ValidateFormula($request: ValidationRequestInput!) {
                                validateFormula(request: $request) {
                                    isValid
                                    error
                                    result
                                    evaluatedFormula
                                    source
                                }
                            }
                        `,
                        variables: {
                            request: requestData
                        }
                    })
                });

                const data = await response.json();

                if (data.errors) {
                    console.error('GraphQL errors:', data.errors);
                    updateValidationStatus('error');
                    showErrors(['Backend validation error']);
                    updateResult(null);
                    updateBackendIndicator(false, 'Error');
                    return;
                }

                const validationResult = data.data.validateFormula;

                if (validationResult.isValid) {
                    updateValidationStatus('valid');
                    showErrors([]);
                    updateResult(validationResult.result);

                    // Add to history
                    addToHistory(formula, validationResult.result);

                    // Clear ACE editor annotations
                    editor.session.clearAnnotations();
                } else {
                    updateValidationStatus('error');

                    // Parse error for better display
                    const error = validationResult.error || 'Invalid formula';
                    showErrors([error]);
                    updateResult(null);

                    // Add error annotation to ACE editor at relevant location
                    const locationMatch = error.match(/line\s+(\d+),\s*col(?:umn)?\s+(\d+)/i);
                    const row = locationMatch ? Math.max(parseInt(locationMatch[1], 10) - 1, 0) : 0;
                    const column = locationMatch ? Math.max(parseInt(locationMatch[2], 10) - 1, 0) : 0;
                    editor.session.setAnnotations([{
                        row,
                        column,
                        text: error,
                        type: "error"
                    }]);
                    editor.scrollToLine(row, true, true, function () {});
                    editor.gotoLine(row + 1, column, true);
                }

                updateBackendIndicator(false, 'Ready');

            } catch (error) {
                console.error('Validation error:', error);
                updateValidationStatus('error');
                showErrors(['Failed to connect to backend']);
                updateResult(null);
                updateBackendIndicator(false, 'Offline');
            }
        }

        // History management
        function addToHistory(formula, result) {
            formulaHistory.unshift({ formula, result });
            if (formulaHistory.length > 10) {
                formulaHistory.pop();
            }
            renderHistory();
        }

        function renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            formulaHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <span>${item.formula}</span>
                    <span class="history-result">= ${item.result?.toFixed(4) || 'Error'}</span>
                `;
                historyItem.addEventListener('click', () => {
                    editor.setValue(item.formula, 1);
                });
                historyList.appendChild(historyItem);
            });
        }

        // Functions panel
        function renderFunctions() {
            renderFunctionCategory('basicFunctions', functionsDB.basic);
            renderFunctionCategory('trigFunctions', functionsDB.trig);
            renderFunctionCategory('mathFunctions', functionsDB.math);
            renderFunctionCategory('statFunctions', functionsDB.stat);
        }

        function renderFunctionCategory(elementId, functions) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            functions.forEach(func => {
                const item = document.createElement('div');
                item.className = 'function-item';
                item.innerHTML = `
                    <div class="function-name">${func.name}</div>
                    <div class="function-desc">${func.desc}</div>
                `;
                item.title = func.desc;
                item.tabIndex = 0;
                const insert = () => {
                    const funcName = func.name.split('(')[0] + '(';
                    insertIntoEditor(funcName);
                };
                item.addEventListener('click', insert);
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        insert();
                    }
                });
                container.appendChild(item);
            });
        }

        // Test Suite
        async function loadTestCases() {
            try {
                const response = await fetch('test-cases.json');
                const data = await response.json();
                testCases = data.testCases;

                // Update sources from test data
                if (data.measuredValues) {
                    measuredValues = data.measuredValues;
                    renderMeasuredValues();
                }
                if (data.constants) {
                    constants = data.constants;
                    renderConstants();
                }
            } catch (error) {
                console.error('Failed to load test cases:', error);
                testCases = [];
            }
        }

        async function runTests() {
            if (testRunning) return;

            testRunning = true;
            currentTestIndex = 0;
            const results = [];
            const testSpeed = document.getElementById('testSpeed').value;
            const delay = testSpeed === 'instant' ? 0 : testSpeed === 'fast' ? 100 : 500;

            document.getElementById('testResults').innerHTML = '';
            document.getElementById('runTestsBtn').disabled = true;

            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                const result = await runSingleTest(testCase);
                results.push(result);

                updateTestProgress(i + 1, testCases.length, results);
                renderTestResult(result);

                if (delay > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }

            testRunning = false;
            document.getElementById('runTestsBtn').disabled = false;

            const passed = results.filter(r => r.passed).length;
            const failed = results.filter(r => !r.passed).length;
            showToast(`Test suite completed: ${passed} passed, ${failed} failed`,
                      failed > 0 ? 'error' : 'success');
        }

        async function runSingleTest(testCase) {
            const requestData = {
                formula: testCase.formula,
                measuredValues: Object.entries(measuredValues).map(([id, data]) => ({
                    id: id,
                    name: data.name,
                    value: data.value,
                    unit: data.unit
                })),
                constants: Object.entries(constants).map(([id, data]) => ({
                    id: id,
                    name: data.name,
                    value: data.value
                }))
            };

            try {
                const response = await fetch(API_CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: `
                            mutation ValidateFormula($request: ValidationRequestInput!) {
                                validateFormula(request: $request) {
                                    isValid
                                    error
                                    result
                                    evaluatedFormula
                                    source
                                }
                            }
                        `,
                        variables: {
                            request: requestData
                        }
                    })
                });

                const data = await response.json();
                const validationResult = data.data.validateFormula;

                if (testCase.expectedError) {
                    return {
                        ...testCase,
                        passed: !validationResult.isValid,
                        actual: validationResult.error || 'No error',
                        expected: testCase.expectedError
                    };
                } else {
                    const passed = validationResult.isValid &&
                                   Math.abs(validationResult.result - testCase.expectedResult) < 0.001;
                    return {
                        ...testCase,
                        passed,
                        actual: validationResult.result,
                        expected: testCase.expectedResult
                    };
                }
            } catch (error) {
                return {
                    ...testCase,
                    passed: false,
                    actual: 'Network error',
                    expected: testCase.expectedResult || testCase.expectedError
                };
            }
        }

        function updateTestProgress(current, total, results) {
            const progress = (current / total) * 100;
            document.getElementById('testProgress').style.width = `${progress}%`;
            document.getElementById('testProgressText').textContent = `${current} / ${total} tests`;

            const passed = results.filter(r => r.passed).length;
            const failed = results.filter(r => !r.passed).length;
            document.getElementById('testStats').textContent = `Pass: ${passed} | Fail: ${failed}`;
        }

        function renderTestResult(result) {
            const container = document.getElementById('testResults');
            const item = document.createElement('div');
            item.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
            item.innerHTML = `
                <div class="test-info">
                    <div class="test-name">${result.name}</div>
                    <div class="test-formula">${result.formula}</div>
                </div>
                <div class="test-status">
                    <div class="test-expected">
                        Expected: ${result.expected}<br>
                        Actual: ${result.actual}
                    </div>
                    <div class="test-icon ${result.passed ? 'pass' : 'fail'}"></div>
                </div>
            `;
            container.appendChild(item);
        }

        function exportTestResults() {
            const results = Array.from(document.querySelectorAll('.test-result')).map(el => {
                const name = el.querySelector('.test-name').textContent;
                const formula = el.querySelector('.test-formula').textContent;
                const expected = el.querySelector('.test-expected').textContent;
                const passed = el.classList.contains('pass');
                return { name, formula, expected, passed };
            });

            const csv = 'Name,Formula,Expected,Passed\n' +
                        results.map(r => `"${r.name}","${r.formula}","${r.expected}",${r.passed}`).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test-results.csv';
            a.click();
            URL.revokeObjectURL(url);

            showToast('Test results exported', 'success');
        }

        // Toast notifications
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon"></div>
                <div class="toast-message">${message}</div>
                <div class="toast-close" aria-label="Close"></div>
            `;

            container.appendChild(toast);

            const closeToast = () => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            };

            toast.querySelector('.toast-close').addEventListener('click', closeToast);
            setTimeout(closeToast, duration);
        }

        // Simulate data changes
        function simulateDataChange() {
            const keys = Object.keys(measuredValues);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            const oldValue = measuredValues[randomKey].value;
            const newValue = oldValue + (Math.random() - 0.5) * 10;

            measuredValues[randomKey].value = parseFloat(newValue.toFixed(2));
            renderMeasuredValues();

            showToast(`${measuredValues[randomKey].name} changed from ${oldValue.toFixed(2)} to ${newValue.toFixed(2)}`, 'info');

            // Re-validate with new value
            performBackendValidation();
        }

        // Sample formulas
        const sampleFormulas = [
            '($temperature * #conversion_factor) + 32',
            'sqrt($pressure * $humidity)',
            'sin(#pi / 2) + cos(0)',
            'max($temperature, $pressure, $humidity)',
            'if($temperature > #max_temp, 1, 0)',
            'log10($voltage) * #gravity',
            '($flow_rate * #gravity) / $pressure',
            'abs($temperature - #max_temp)',
            'round($humidity / 10, 1) * #conversion_factor'
        ];

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            // Theme handling
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('theme');
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');

            initializeEditor();
            renderSourceLists();
            renderFunctions();
            await loadTestCases();

            // Initial validation
            setTimeout(performBackendValidation, 100);

            // Apply theme after editor init
            applyTheme(initialTheme);

            // Theme toggle
            document.getElementById('themeToggleBtn').addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
                const next = current === 'dark' ? 'light' : 'dark';
                applyTheme(next);
                localStorage.setItem('theme', next);
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    const parent = tab.parentElement.parentElement;

                    parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    parent.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    const contentId = tabName + 'Tab';
                    const content = document.getElementById(contentId);
                    if (content) content.classList.add('active');
                });
            });

            // Search functionality
            document.getElementById('measuredSearch').addEventListener('input', (e) => {
                renderMeasuredValues(e.target.value);
            });

            document.getElementById('constantsSearch').addEventListener('input', (e) => {
                renderConstants(e.target.value);
            });

            // Toolbar buttons
            document.getElementById('validateBtn').addEventListener('click', () => {
                performBackendValidation();
            });

            document.getElementById('clearBtn').addEventListener('click', () => {
                editor.setValue('', 1);
                showToast('Editor cleared', 'info');
            });

            document.getElementById('samplesBtn').addEventListener('click', () => {
                const formula = sampleFormulas[Math.floor(Math.random() * sampleFormulas.length)];
                editor.setValue(formula, 1);
                showToast('Sample formula inserted', 'info');
            });

            document.getElementById('copyFormulaBtn').addEventListener('click', () => {
                const formula = editor.getValue();
                navigator.clipboard.writeText(formula);
                showToast('Formula copied to clipboard', 'success');
            });

            document.getElementById('copyResultBtn').addEventListener('click', () => {
                const result = document.getElementById('resultValue').textContent;
                if (result && result !== 'Enter a valid formula...') {
                    navigator.clipboard.writeText(result);
                    showToast('Result copied to clipboard', 'success');
                }
            });

            document.getElementById('resultCopyBtn').addEventListener('click', () => {
                const result = document.getElementById('resultValue').textContent;
                if (result && result !== 'Enter a valid formula...') {
                    navigator.clipboard.writeText(result);
                    showToast('Result copied', 'success');
                }
            });

            // Test suite
            document.getElementById('testSuiteBtn').addEventListener('click', () => {
                document.getElementById('testModal').classList.add('show');
            });

            document.getElementById('closeTestModal').addEventListener('click', () => {
                document.getElementById('testModal').classList.remove('show');
            });

            document.getElementById('runTestsBtn').addEventListener('click', runTests);

            document.getElementById('exportTestsBtn').addEventListener('click', exportTestResults);

            // Simulate changes
            document.getElementById('simulateChangeBtn').addEventListener('click', simulateDataChange);

            // Add source buttons
            document.getElementById('addMeasuredBtn').addEventListener('click', () => {
                const key = prompt('Enter variable name (without $):');
                if (key) {
                    const name = prompt('Enter display name:');
                    const value = parseFloat(prompt('Enter value:'));
                    if (name && !isNaN(value)) {
                        measuredValues['$' + key] = { name, value };
                        renderMeasuredValues();
                        showToast(`Added ${name}`, 'success');
                    }
                }
            });

            document.getElementById('addConstantBtn').addEventListener('click', () => {
                const key = prompt('Enter constant name (without #):');
                if (key) {
                    const name = prompt('Enter display name:');
                    const value = parseFloat(prompt('Enter value:'));
                    if (name && !isNaN(value)) {
                        constants['#' + key] = { name, value };
                        renderConstants();
                        showToast(`Added ${name}`, 'success');
                    }
                }
            });

            // Close modal on background click
            document.getElementById('testModal').addEventListener('click', (e) => {
                if (e.target.id === 'testModal') {
                    document.getElementById('testModal').classList.remove('show');
                }
            });
        });

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (editor) editor.setTheme('ace/theme/tomorrow_night');
                const icon = document.querySelector('#themeToggleBtn .icon');
                if (icon) { icon.classList.remove('icon-moon'); icon.classList.add('icon-sun'); }
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                if (editor) editor.setTheme('ace/theme/chrome');
                const icon = document.querySelector('#themeToggleBtn .icon');
                if (icon) { icon.classList.remove('icon-sun'); icon.classList.add('icon-moon'); }
            }
            // Force ACE to fully refresh rendering to avoid color glitches
            if (editor) {
                setTimeout(() => {
                    try {
                        editor.renderer.updateFull(true);
                        editor.resize(true);
                    } catch (e) { /* noop */ }
                }, 0);
            }
        }
    </script>
</body>
</html>
